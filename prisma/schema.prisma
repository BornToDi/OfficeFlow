// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "mysql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL") // for prisma migrate
}

enum Role {
  employee
  supervisor
  accounts
  management
}

enum BillStatus {
  DRAFT
  SUBMITTED
  APPROVED_BY_SUPERVISOR
  APPROVED_BY_ACCOUNTS
  APPROVED_BY_MANAGEMENT
  REJECTED_BY_SUPERVISOR
  REJECTED_BY_ACCOUNTS
  REJECTED_BY_MANAGEMENT
  PAID
}

model User {
  id             String        @id @default(cuid())
  name           String
  email          String        @unique
  role           Role          @default(employee)
  designation    String?
  employeeCode   String?       @unique
  passwordHash   String? // ‚Üê ADD THIS
  supervisor     User?         @relation("SupervisorEmployees", fields: [supervisorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  supervisorId   String?
  employees      User[]        @relation("SupervisorEmployees")
  assignedBills  Bill[]        @relation("SupervisorAssignedBills")
  bills          Bill[]        @relation("EmployeeBills")
  actorHistories BillHistory[] @relation("ActorHistory")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([supervisorId])
}

model Bill {
  id             String @id @default(cuid())
  companyName    String
  companyAddress String
  employee       User   @relation("EmployeeBills", fields: [employeeId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  employeeId     String

  // NEW: assigned supervisor for this bill (optional)
  supervisor   User?   @relation("SupervisorAssignedBills", fields: [supervisorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  supervisorId String?

  amount        Decimal       @db.Decimal(12, 2)
  amountInWords String
  status        BillStatus    @default(SUBMITTED)
  items         BillItem[]
  history       BillHistory[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([employeeId])
  @@index([supervisorId])
}

// prisma/schema.prisma
model BillItem {
  id        String   @id @default(cuid())
  bill      Bill     @relation(fields: [billId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  billId    String
  date      DateTime
  from      String
  to        String
  transport String?
  purpose   String
  amount    Decimal  @db.Decimal(12, 2)

  // üëá NEW: per-row attachment URL (e.g., /uploads/xxx.pdf or /uploads/xxx.jpg)
  attachmentUrl String?

  @@index([billId])
  @@index([date])
}

model BillHistory {
  id        String     @id @default(cuid())
  bill      Bill       @relation(fields: [billId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  billId    String
  status    BillStatus
  actor     User?      @relation("ActorHistory", fields: [actorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  actorId   String?
  comment   String?    @db.LongText
  timestamp DateTime   @default(now())

  @@index([billId])
  @@index([actorId])
}
